---
title: "Policy Simulation"
author: "Lei Bill Wang"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose of this file

This file simulates differnet policies under the setup of Wang & Ahn (2025), "Attention vs Choice in Incomplete 
Welfare Take-up: What Works for WIC?"

The scenario that we have in mind is after the 2007 food package revision and at mediumly generous state group
## Necessary packages
```{r}
library(dplyr)
```

## Preliminaries

# Set the basic variables
We first simulate N representative households from year 2009 and medium state group
```{r}
N  = 450*5
T = 30
names_df <- c("id","month","NK1", "NK2to5", "kid1age", "kid2age", "YA", "edu", "LA",
              "Y", "logB", "Q","Pa", "Pc", "S", "pastD", "D")
K  = length(names_df)
df <- as.data.frame(matrix(NA,nrow = N*T,K))
names(df) <- names_df

# Set id and month
df$id <- rep(1:N,each = T)
df$month <- rep(1:T)

# Set edu and LA
df$edu <- rep(c(1,2,3),each = T)
df$LA <- rep(c(10,15,20),each = 3*T)

# Set number of kids each period
# There are five possible initial age of kidage 1: 3,6,9,12,15
# Half of the households have a newborn at the TT+1 month
# Each household has at most two kids
kid1age_initial <- rep(c(3,6,9,12,15),each = 3*3)
kid1age <- unlist(lapply(kid1age_initial, function(age) age + (0:(T-1))))
df$kid1age <- kid1age

TT = 12 # A second child is born in TT+1 month
kid2age <- c(rep(NA,T),rep(NA,TT),seq(1:(T-TT)))
df$kid2age <- kid2age
```

# Generate the secondary variables based on the basic variables
```{r}
set.seed(1234) # set seed to ensure replicability

# Generate NK1 and NK25
df$NK1 <- (df$kid1age < 13) + ifelse(df$kid2age %in% seq(1,12),1,0)
df$NK2to5 <- (df$kid1age >= 13) + ifelse(df$kid2age %in% seq(13,48),1,0)

# Generate YA
df$YA <- pmin(df$kid1age, df$kid2age, na.rm = TRUE)

# Generate Y
df$Y <- ifelse(df$YA %in% c(1,13,25,37),1,0)


# Generate benefit 
df <- df %>%
  mutate(logB = case_when(
    NK1 == 0 & NK2to5 == 1 ~ log(100),
    NK1 == 1 & NK2to5 == 0 ~ log(150),
    NK1 == 0 & NK2to5 == 2 ~ log(130),
    NK1 == 1 & NK2to5 == 1 ~ log(180),
  ))



df$Q <- rep(rnorm(N),each = T) 

# Set the utility parameters

gamma0 <- -2.71849824
gamma_logB <- 0.333741304
gamma_pso <- -0.69188367
gamma_LA <- 0.000546293
gamma_edu <- -0.01911214

beta0 <- 1.241452303
beta_logB <- 0.148335799
beta_pso <- -0.49505725
beta_sh <- -0.36278896
beta_sLA <- 0.010314497
beta_edu <- 0.067525853

sigma1 <- exp(0.454441558)
sigma2 <- exp(-0.10685342)

```

# Simulate take-up based on the basic and secondary variables
```{r}
for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB*X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB*X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])

    d0 <- di[t] # update the "initial condition"
  }
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]

sum(df$D[df$YA<=12])/sum(df$YA<=12)

sum(df$D[df$YA>12])/sum(df$YA>12)

df_NI <- df
```


```{r}
hist(df$Pa,breaks = seq(0,1,0.05),main = "",xlab = "Attention Probability",cex.lab = 1.5,cex.axis=1.5)
hist(df$Pc,breaks = seq(0,1,0.05),main = "",xlab = "Choice Probability",cex.lab = 1.5,cex.axis=1.5)

mean(df$logB[df$D == 1])
mean(df$NK1[df$D == 1])
mean(df$YA[df$D == 1])
mean(df$edu[df$D == 1])
mean(df$LA[df$D == 1])
mean(df$Q[df$D == 1])

Q_NI <- df$Q[df$D == 1]

Q_NI0 <- df$Q[df$D == 0]

# plot average participation duration across Q

```

# Coutnerfactual: 100% attention

```{r}
#set.seed(1234) # set seed to ensure replicability
#df$Q <- rep(rnorm(N),each = T) 



for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB*X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB*X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    di[t] <- rbinom(1,1,1) * rbinom(1,1,Pci[t])

    d0 <- di[t] # update the "initial condition"
  }
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]

sum(df$D[df$YA<=12])/sum(df$YA<=12)

sum(df$D[df$YA>12])/sum(df$YA>12)
```


# Counterfactual: 100% choice
```{r}
#set.seed(1234) # set seed to ensure replicability
# Set random effect Q
#df$Q <- rep(rnorm(N),each = T) 



for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB * X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB * X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,1)

    d0 <- di[t] # update the "initial condition"
  }
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]

sum(df$D[df$YA<=12])/sum(df$YA<=12)

sum(df$D[df$YA>12])/sum(df$YA>12)
```
# More realistic policy counterfactual

We mimic the 


# Attention raised to 100% when exit the program

```{r}
#set.seed(1234) # set seed to ensure replicability
# Set random effect Q
#df$Q <- rep(c(-0.5,-0.4,-0.3,-0.2,-0.1),each = 3*3*10*T) # Let's help those with low thriftiness
#df$Q <- rep(rnorm(N),each = T) 

AB <- 1

for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB * X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB * X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    
  # attention raising policy intervention
    if (t >= 2){ # The intervention will only be triggered when a household exits WIC
      if (X$pastD[t-1] == 1 & X$pastD[t] == 0){
        # print(c(i,t,Pai[t]))
        Pai[t] <- min(Pai[t] + AB,1) 
        di[t] <- rbinom(1,1,Pai[t]) * rbinom(1,1,Pci[t]) 
        #print(c(i,t,Pai[t]))
      } else {
        di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])
      }
    } else {
      di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])
    }
    
    d0 <- di[t] # update the "initial condition"
    
  } 
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]

sum(df$D[df$YA<=12])/sum(df$YA<=12)

sum(df$D[df$YA>12])/sum(df$YA>12)

df_AB <- df
```

```{r}
hist(df$Pa,breaks = seq(0,1,0.05))
hist(df$Pc,breaks = seq(0,1,0.05))

mean(df$logB[df$D == 1])
mean(df$NK1[df$D == 1])
mean(df$YA[df$D == 1])
mean(df$edu[df$D == 1])
mean(df$LA[df$D == 1])
mean(df$Q[df$D == 1])

# sd(df$logB[df$D == 1])
# sd(df$NK1[df$D == 1])
# sd(df$YA[df$D == 1])
# sd(df$edu[df$D == 1])
# sd(df$LA[df$D == 1])
# sd(df$Q[df$D == 1])

Q_AR <- df$Q[df$D == 1]
```

# Chioce inducing by an increase of 1% for 30 months

```{r}
#set.seed(1234) # set seed to ensure replicability
# Set random effect Q
#df$Q <- rep(c(-0.5,-0.4,-0.3,-0.2,-0.1),each = 3*3*10*T) # Let's help those with low thriftiness
#df$Q <- rep(rnorm(N),each = T) 

CN <- 0.0333

for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB * X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB * X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    
  # choice inducing policy intervention
    if (X$pastD[t] == 1 & X$YA[t] <= 30){ 
      # The intervention will only be triggered when the household is in the program AND
      # YA is between the 1 to 30 month
      Pci[t] <- min(Pci[t] + CN,1) # choice raise by 1%
      di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])
      # print(c(i,t))
    } else {
      di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])
    }
    
    d0 <- di[t] # update the "initial condition"
  } 
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]

sum(df$D[df$YA<=12])/sum(df$YA<=12)

sum(df$D[df$YA>12])/sum(df$YA>12)

df_CN <- df
```



```{r}
hist(df$Pa,breaks = seq(0,1,0.05))
hist(df$Pc,breaks = seq(0,1,0.05))

mean(df$logB[df$D == 1])
mean(df$NK1[df$D == 1])
mean(df$YA[df$D == 1])
mean(df$edu[df$D == 1])
mean(df$LA[df$D == 1])
mean(df$Q[df$D == 1])

Q_CI <- df$Q[df$D == 1]
```

```{r}
library(ggplot2)

# Define color scheme
cols <- c("NI" = "gray", "AR" = "blue", "CI" = "red")

# Create combined dataframe (ordered by desired appearance)
plot_data <- rbind(
  data.frame(Q = Q_NI, Group = "NI"),
  data.frame(Q = Q_AR, Group = "AR"),
  data.frame(Q = Q_CI, Group = "CI")
)


ggplot(plot_data, aes(x = Q, color = Group)) +
  geom_density(linewidth = 1.5) +
  scale_color_manual(
    values = c("NI" = "gray", "AR" = "blue", "CI" = "red"),
    name = ""
  ) +
  labs(x = "Random effect Q", y = "Density") +
  theme_minimal(base_size = 20) +
  theme(
    legend.position = 'top',
    legend.key = element_blank(),  # Remove legend key background
    legend.spacing.x = unit(0.5, 'cm')  # Add space between legend items
  ) +
  guides(color = guide_legend(
    override.aes = list(
      linetype = 1.5,
      shape = 1,         # Absolutely no shapes
      linewidth = 1,      # Line thickness
      fill = NA,          # No fill
      alpha = 1,          # No transparency
      colour = c("blue", "red", "gray")  # Explicit colors
    ),
    keywidth = unit(1, "cm")  # Lengthen the legend lines
  ))

mean(Q_NI > 0)
mean(Q_AR > 0)
mean(Q_CI > 0)

```


```{r}
library(ggplot2)

# Define color scheme
cols <- c("NI" = "gray", "AR" = "blue", "CI" = "red")

# Create combined dataframe (ordered by desired appearance)
plot_data <- rbind(
  data.frame(Q = Q_NI, Group = "NI"),
  data.frame(Q = Q_AR, Group = "AR"),
  data.frame(Q = Q_CI, Group = "CI")
)


ggplot(plot_data[plot_data$Group %in% c("NI", "CI"),], aes(x = Q, color = Group)) +
  geom_density(linewidth = 1.5) +
  scale_color_manual(
    values = c("NI" = "gray", "CI" = "red"),
    name = ""
  ) +
  labs(x = "Random effect Q", y = "Density") +
  theme_minimal(base_size = 20) +
  theme(
    legend.position = 'top',
    legend.key = element_blank(),  # Remove legend key background
    legend.spacing.x = unit(0.5, 'cm')  # Add space between legend items
  ) + xlim(-0.25,1.25) +
  guides(color = guide_legend(
    override.aes = list(
      linetype = 1.5,
      shape = 1,         # Absolutely no shapes
      linewidth = 1,      # Line thickness
      fill = NA,          # No fill
      alpha = 1,          # No transparency
      colour = c("red", "gray")  # Explicit colors
    ),
    keywidth = unit(1, "cm")  # Lengthen the legend lines
  ))

```


```{r}
# Define color scheme
cols <- c("NI" = "gray", "AR" = "blue", "CI" = "red")

# Create combined dataframe (ordered by desired appearance)
plot_data <- rbind(
  data.frame(Q = Q_NI, Group = "NI"),
  data.frame(Q = Q_AR, Group = "AR"),
  data.frame(Q = Q_CI, Group = "CI")
)

# Base plot setup
base_plot <- ggplot() +
  scale_color_manual(values = cols) +
  labs(x = "Random effect Q", y = "Density") +
  theme_minimal(base_size = 20) +
  xlim(-2, 3.5) + ylim(0, 0.7) +
  theme(legend.position = "none")

# Build plots with explicit layer order
p2 <- base_plot +
  geom_density(
    data = subset(plot_data, Group == "NI"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  )

p3 <- base_plot +
  geom_density(
    data = subset(plot_data, Group == "NI"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  ) +
  geom_density(
    data = subset(plot_data, Group == "AR"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  )

p4 <- base_plot +  
  geom_rect(
    aes(xmin = -0.2, xmax = 0.4, ymin = -Inf, ymax = Inf),
    fill = "pink", alpha = 0.3, color = NA  # alpha controls transparency
  ) +
  geom_density(
    data = subset(plot_data, Group == "NI"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  ) +
  geom_density(
    data = subset(plot_data, Group == "AR"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  ) +
  geom_density(
    data = subset(plot_data, Group == "CI"),
    aes(x = Q, color = Group),
    linewidth = 1.5
  )  
  # Add transparent pink rectangle for -1 < Q < 0.25
  

p2
p3
p4

# # Display plots
# (p1 | p2) / (p3 | p4)
```
```{r}
library(dplyr)
library(ggplot2)

# Step 1: compute max_consec per household, filter Q
result_AB <- df_AB %>%
  group_by(id) %>%
  summarise(
    max_consec = {
      runs <- rle(D)
      if (any(runs$values == 1)) {
        max(runs$lengths[runs$values == 1])
      } else {
        0
      }
    },
    Q_value = first(Q),
    Pa_value = first(Pa),
    .groups = "drop"
  ) %>%
  filter(Q_value >= -2, Q_value <= 2)

# Step 2: bin Q for plotting
result_AB <- result_AB %>%
  mutate(
    Q_bin = cut(
      Q_value,
      breaks = seq(-2, 2, by = 0.2),
      include.lowest = TRUE,
      right = FALSE
    )
  )


# Step 1: compute max_consec per household, filter Q
result_CN <- df_CN %>%
  group_by(id) %>%
  summarise(
    max_consec = {
      runs <- rle(D)
      if (any(runs$values == 1)) {
        max(runs$lengths[runs$values == 1])
      } else {
        0
      }
    },
    Q_value = first(Q),
    Pa_value = first(Pa),
    .groups = "drop"
  ) %>%
  filter(Q_value >= -2, Q_value <= 2)

# Step 2: bin Q for plotting
result_CN <- result_CN %>%
  mutate(
    Q_bin = cut(
      Q_value,
      breaks = seq(-2, 2, by = 0.2),
      include.lowest = TRUE,
      right = FALSE
    )
  )

# Kernel regression plot
plot(
  ksmooth(result_CN$Q_value, result_CN$max_consec, kernel = "normal", bandwidth = 0.2),
  type = "l", col = "red", lwd = 5,
  xlim = c(-2, 2), ylim = c(0, 30),
  xlab = "Random effect Q", ylab = "Consecutive participation",
  cex.lab = 1.5
)
lines(
  ksmooth(result_AB$Q_value, result_AB$max_consec, kernel = "normal", bandwidth = 0.2),
  col = "blue", lwd = 5
)
legend("bottomright", legend = c("Choice nudge", "Attention boost"), col = c("red", "blue"), lwd = 2)
# par(new=TRUE)
# plot(df_NI$Q,df_NI$Pa,xlim = c(-2,2),yaxt = "n",pch = 2,ylab = "",xlab ="",cex = 0.1,col = "blue")
# axis(4)
# par(new=TRUE)
# plot(df_NI$Q,df_NI$Pc,xlim = c(-2,2),yaxt = "n",pch = 2,ylab = "",xlab ="",cex = 0.1)

# plot(df_CN$Q,df_CN$Pa) # same as plot(df_NI$Q,df_NI$Pa)
```

```{r}
# Set up the plot area
par(mar = c(5, 4, 4, 4) + 0.1)  # Extra space for right y-axis

# First plot (Pa - left y-axis)
plot(df_NI$Q, df_NI$Pa, 
     xlim = c(-2, 2), ylim = c(0, 1),
     pch = 2, cex = 0.25, col = "blue",
     xlab = "Random Effect (Q)", ylab = "Probability",
     cex.lab = 1.5,
     main = "")

# Add transparent pink rectangle for -1 < Q < 0.25
rect(-0.2, -0.1, 0.4, 1.1, 
     col = adjustcolor("pink", alpha.f = 0.5), border = NA)

# Redraw points to ensure they're visible
points(df_NI$Q, df_NI$Pa, pch = 2, cex = 0.25, col = "blue")

# Second plot (Pc - right y-axis)
par(new = TRUE)
plot(df_NI$Q, df_NI$Pc, 
     xlim = c(-2, 2), ylim = c(0, 1),
     axes = FALSE, pch = 1, cex = 0.5, col = "red",
     xlab = "", ylab = "")

# Add right y-axis
# axis(4)
# mtext("Choice Probability (Pc)", side = 4, line = 3)

# Add legend
legend("bottomright", 
       legend = c("Attention (Pa)", "Choice (Pc)"),
       pch = c(2, 1), col = c("blue", "red"),
       bg = "white")
```

# Attention raising for everyone by 30% in period 1

This resembles the intervention by Finkelstein and Notowidigto (2019).
It might be too expensive for WIC to implement this policy, though.

```{r}
#set.seed(1234) # set seed to ensure replicability
#df$Q <- rep(rnorm(N),each = T) 



for (i in 1:N){ # loop through all households
  di <- rep(NA,T)
  Si <- rep(NA,T)
  Pai <- rep(NA,T)
  Pci <- rep(NA,T)
  pastd <- rep(NA,T)
  
  X <- df[df$id==i,]
  
  d0 = 0 # initial condition 0
  
  # Simulate decisions sequentially
  for (t in 1:T){
    pastd[t] <- d0 # record last period decision
    
    Pai[t] <- pnorm(gamma0 + 
                   gamma_logB * X$logB[t] 
                 + gamma_pso * ifelse(X$YA[t] > 12,1,0)
                 + gamma_LA * X$LA[t]
                 + gamma_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma1 * X$Q[t]
                 ) # record attention probability
    
    Si[t] <- max(1-d0, d0*X$Y[t])
      
    Pci[t] <- pnorm(beta0 + 
                   beta_logB*X$logB[t] 
                 + beta_pso * ifelse(X$YA[t] > 12,1,0)
                 + beta_sh * Si[t]
                 + beta_sLA * Si[t] * X$LA[t]
                 + beta_edu * X$edu[t] * ifelse(X$YA[t] > 12,1,0)
                 + sigma2 * X$Q[t]
                 ) # record choice probability
    
    # intervene when the household has never participated before
    if(t == 1){
      Pai[t] <- Pai[t] + 0.3
      Pci[t] <- Pci[t] 
      di[t] <- rbinom(1,1,min(Pai[t],1)) * rbinom(1,1,min(Pci[t],1))
    } else {
      di[t] <- rbinom(1,1,Pai[t]^(1-d0)) * rbinom(1,1,Pci[t])
    }

    d0 <- di[t] # update the "initial condition"
  }
  
  # fill in the data for df
  df$pastD[df$id==i] <- pastd
  df$D[df$id==i] <- di
  df$Pa[df$id==i] <- Pai
  df$Pc[df$id==i] <- Pci
  df$S[df$id==i] <- Si
}

sum(df$D)/dim(df)[1]
```



```{r}
# hist(df$Pa,breaks = seq(0,1,0.05))
# hist(df$Pc,breaks = seq(0,1,0.05))

mean(df$logB[df$D == 1])
mean(df$NK1[df$D == 1])
mean(df$YA[df$D == 1])
mean(df$edu[df$D == 1])
mean(df$LA[df$D == 1])
mean(df$Q[df$D == 1])

Q_FN0 <- df$Q[df$D == 0]
```

```{r}
# Define color scheme
cols <- c("NI0" = "gray", "FN0" = "red")

# Create combined dataframe (ordered by desired appearance)
plot_data0 <- rbind(
  data.frame(Q = Q_NI0, Group = "NI0"),
  data.frame(Q = Q_FN0, Group = "FN0")
)

# Base plot setup
ggplot(plot_data0, aes(x = Q, color = Group)) +
  geom_density(linewidth = 1.5) +
  scale_color_manual(
    values = c("NI0" = "gray",  "FN0" = "red"),
    name = ""
  ) +
  labs(x = "Random effect Q", y = "Density") +
  theme_minimal(base_size = 20) +
  theme(
    legend.position = 'top',
    legend.key = element_blank(),  # Remove legend key background
    legend.spacing.x = unit(0.5, 'cm')  # Add space between legend items
  ) +
  guides(color = guide_legend(
    override.aes = list(
      linetype = 1.5,
      shape = 1,         # Absolutely no shapes
      linewidth = 1.5,      # Line thickness
      fill = NA,          # No fill
      alpha = 1,          # No transparency
      colour = c("red", "gray")  # Explicit colors
    ),
    keywidth = unit(1, "cm")  # Lengthen the legend lines
  ))
```





